{% extends "base.html" %}

{%block headers%}
    <title>
        Typing Test
    </title>
    <style>
        .omission {
            background-color: #edfa39;
        }

        .incorrect {
            background-color: #f36f6f;
        }
    </style>
{%endblock%}

{% block content %}
  <div class="max-w-2xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-lg">
    <h1 class="text-2xl font-bold mb-4">Typing Test</h1>
    <p class="mb-4 text-gray-600">Type the following text as accurately and quickly as you can.</p>

    <div class="bg-gray-100 p-4 rounded text-lg font-mono" id="test-text">
      The quick brown fox jumps over the lazy dog.
    </div>

    <textarea id="typing-area" class="w-full mt-4 p-2 border rounded" rows="4" placeholder="Start typing here..."></textarea>
    
    <div class="mt-4 flex justify-between">
      <button id="start-test" class="px-4 py-2 bg-blue-500 text-white rounded">Start Test</button>
      <button id="submit-test" class="px-4 py-2 bg-green-500 text-white rounded" disabled>Submit</button>
    </div>

    <div id="result-container" class="mt-6 p-4 rounded hidden">
      <h2 class="text-xl font-semibold">Test Result</h2>
      <div id="result-content" class="mt-2 font-mono"></div>
      <div id="stats-content" class="mt-4 text-gray-700"></div>
    </div>
  </div>

  <script>
    let startTime;
    let testStarted = false;

    document.getElementById('start-test').addEventListener('click', function() {
      if (!testStarted) {
        testStarted = true;
        startTime = new Date();
        document.getElementById('typing-area').focus();
        this.disabled = true;
        document.getElementById('submit-test').disabled = false;
        console.log("Test started at: ", startTime);
      }
    });

    document.getElementById('submit-test').addEventListener('click', async function() {
      const typingContent = document.getElementById('typing-area').value;
      const originalText = document.getElementById('test-text').innerText;
      const duration = (new Date() - startTime) / 1000;
      console.log("Test duration: ", duration, "seconds");
      console.log("User input:", typingContent);

      const formData = new FormData();
      formData.append("orig_text", originalText);
      formData.append("typed_text", typingContent);
      formData.append("duration_seconds", duration);

      const response = await fetch('/api/compare', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      console.log("Server response:", result);

      document.getElementById('result-container').classList.remove('hidden');
      document.getElementById('result-content').innerHTML = result.diff_html;
      document.getElementById('stats-content').innerHTML = `<pre>${JSON.stringify(result.stats, null, 2)}</pre>`;
    });
  </script>
{% endblock %}
